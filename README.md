# Tor HTTP Proxy с самописным балансировщиком

Простой HTTP прокси-сервер с round-robin балансировкой через SOCKS5 прокси Tor. Заменяет HAProxy и Privoxy самописным решением на Python.

## Особенности

- ✅ **Самописный HTTP балансировщик** - никаких внешних зависимостей
- ✅ **Round-robin балансировка** между портами Tor SOCKS5
- ✅ **Быстрая статистика** по каждому прокси-порту
- ✅ **Веб админ-панель** с красивой визуализацией
- ✅ **Автоматическое управление** Tor инстансами по подсетям
- ✅ **Мониторинг здоровья** прокси-серверов
- ✅ **Real-time статистика** запросов и производительности

## Архитектура

```
HTTP Client → HTTP Load Balancer (Port 8080) → SOCKS5 Tor Instances → Internet
                     ↓
                Admin Panel (Port 5000) 
```

## Быстрый старт

### Вариант 1: Docker (рекомендуется)

```bash
# Клонируем репозиторий
git clone <repository>
cd rotating-tor-http-proxy

# Запускаем с новым балансировщиком
docker-compose -f docker-compose_new.yml up -d

# Проверяем логи
docker logs tor-http-proxy-balancer

# Открываем админ панель
# http://localhost:5000
```

### Вариант 2: Локальная установка

```bash
# Устанавливаем зависимости
cd src
pip install -r requirements.txt

# Запускаем с админ панелью
python3 admin_panel_new.py

# Или простой запуск
python3 tor_http_proxy.py --port 8080
```

## Использование

### 1. Админ панель
Откройте `http://localhost:5000` для управления:

- **Обзор** - общая статистика системы
- **HTTP Балансировщик** - детальная статистика прокси и производительности
- **Подсети** - управление Tor инстансами по подсетям

### 2. HTTP прокси
Используйте `http://localhost:8080` как HTTP прокси:

```bash
# Прямое использование
curl --proxy http://localhost:8080 https://httpbin.org/ip

# Через браузер - установите прокси: localhost:8080
```

### 3. API управления

```bash
# Статус системы
curl http://localhost:5000/api/status

# Статистика балансировщика
curl http://localhost:5000/api/balancer/stats

# Топ прокси по производительности
curl http://localhost:5000/api/balancer/top-proxies

# Управление сервисами
curl -X POST http://localhost:5000/api/services/start
curl -X POST http://localhost:5000/api/services/stop
curl -X POST http://localhost:5000/api/services/restart

# Управление подсетями
curl -X POST http://localhost:5000/api/subnet/1.2/start -d '{"instances": 3}'
curl -X POST http://localhost:5000/api/subnet/1.2/stop
```

## Конфигурация

### Порты по умолчанию
- **8080** - HTTP Load Balancer
- **5000** - Admin Panel
- **10000+** - SOCKS5 Tor instances
- **30000+** - Tor Control ports

### Переменные окружения

```bash
# Порт HTTP балансировщика
HTTP_PROXY_PORT=8080

# Порт админ панели  
ADMIN_PANEL_PORT=5000

# Интервал проверки здоровья прокси (сек)
HEALTH_CHECK_INTERVAL=30

# Максимальное количество Tor инстансов
MAX_TOR_INSTANCES=100
```

## Статистика балансировщика

Система ведет детальную статистику по каждому SOCKS5 прокси:

### Глобальная статистика
- Общее количество запросов
- Успешных/неудачных запросов  
- Процент успешности
- Среднее время ответа
- Активные/недоступные прокси

### Статистика по прокси
- Порт SOCKS5 прокси
- Количество запросов
- Процент успешности
- Среднее время ответа (общее и последние запросы)
- Мин/макс время ответа
- Запросов в минуту
- Коды ответов HTTP
- Время работы (uptime)
- Рейтинг производительности

### API статистики

```bash
# Все статистики
curl http://localhost:5000/api/balancer/stats

# Топ 10 прокси по производительности
curl http://localhost:5000/api/balancer/top-proxies

# Очистка статистики
curl -X POST http://localhost:5000/api/balancer/clear-stats
```

## Алгоритм балансировки

Используется **Round-Robin** с проверкой здоровья:

1. **Round-Robin распределение** между доступными SOCKS5 прокси
2. **Автоматическое исключение** недоступных прокси
3. **Периодическая проверка** недоступных прокси (каждые 30 сек)
4. **Автоматическое восстановление** прокси при возобновлении работы

## Мониторинг

### Проверка статуса
```bash
# Общий статус
curl http://localhost:5000/api/status

# Статус балансировщика
curl http://localhost:5000/api/balancer/stats | jq '.stats.total_proxies'

# Список активных прокси портов
curl http://localhost:5000/api/balancer/stats | jq '.stats.proxy_ports'
```

### Логи
```bash
# Docker логи
docker logs tor-http-proxy-balancer

# Файл логов (при локальном запуске)
tail -f tor_proxy.log
```

## Производительность

### Оптимизация
- Используйте несколько Tor инстансов для увеличения пропускной способности
- Мониторьте статистику прокси и отключайте медленные
- Настройте лимиты подсетей в зависимости от нагрузки

### Типичные показатели
- **Время ответа**: 1-5 секунд (зависит от Tor цепочки)
- **Пропускная способность**: ~100-500 req/min на инстанс
- **Успешность**: 85-95% (зависит от качества exit нод)

## Отличия от старой версии

| Компонент | Старая версия | Новая версия |
|-----------|---------------|--------------|
| HTTP прокси | HAProxy | Самописный Python |
| SOCKS преобразование | Privoxy | Встроенное в балансировщик |
| Статистика | Внешняя | Встроенная быстрая |
| Конфигурация | Файлы конфигов | Автоматическая |
| Зависимости | HAProxy + Privoxy | Только Python |
| Мониторинг | Ограниченный | Полная статистика |

## Устранение проблем

### Балансировщик не запускается
```bash
# Проверяем порт
netstat -tlnp | grep 8080

# Проверяем логи
docker logs tor-http-proxy-balancer
```

### Нет доступных прокси
```bash
# Проверяем Tor инстансы
curl http://localhost:5000/api/status

# Запускаем подсеть
curl -X POST http://localhost:5000/api/subnet/1.2/start -d '{"instances": 1}'
```

### Медленные запросы
- Проверьте статистику прокси в админ панели
- Перезапустите медленные инстансы
- Используйте больше инстансов

## Безопасность

- Система работает только с локальными подключениями
- Tor трафик автоматически шифруется
- Админ панель доступна только локально (по умолчанию)
- Логи не содержат пользовательских данных

## Лицензия

MIT License - смотрите файл LICENSE для деталей.
